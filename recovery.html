<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Betting Strategy — Martingale-once, Recover-after</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --card-bg: #ffffff;
      --body-bg: #f0f2f5;
      --border: #e0e0e0;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    .dark-mode {
      --body-bg: #121212;
      --card-bg: #1e1e1e;
      --light: #2d2d2d;
      --dark: #f8f9fa;
      --border: #333333;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--body-bg);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo i {
      font-size: 28px;
      color: var(--primary);
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .theme-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    .theme-toggle:hover {
      background: var(--light);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      transition: var(--transition);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
    }

    .card-subtitle {
      color: var(--gray);
      font-size: 14px;
      margin-top: 4px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    label i {
      color: var(--primary);
    }

    input[type="number"] {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--dark);
      font-size: 16px;
      transition: var(--transition);
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    button.secondary {
      background: var(--secondary);
    }

    button.secondary:hover {
      background: #6511a0;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat {
      background: var(--light);
      padding: 16px;
      border-radius: var(--radius);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }

    .stat:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow);
    }

    .stat-title {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }

    .stat.danger {
      border-left-color: var(--danger);
    }

    .stat.success {
      border-left-color: var(--success);
    }

    .stat.warning {
      border-left-color: var(--warning);
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 800px;
    }

    th, td {
      padding: 12px 16px;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--light);
      font-weight: 600;
      text-align: left;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    .positive {
      color: #10b981;
      font-weight: 600;
    }

    .negative {
      color: var(--danger);
      font-weight: 600;
    }

    .notice {
      background: rgba(248, 150, 30, 0.1);
      padding: 16px;
      border-radius: var(--radius);
      margin-top: 20px;
      border-left: 4px solid var(--warning);
    }

    .advice {
      background: rgba(67, 97, 238, 0.1);
      padding: 20px;
      border-radius: var(--radius);
      margin-top: 20px;
      border-left: 4px solid var(--primary);
    }

    .advice h3 {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .advice ul {
      padding-left: 20px;
    }

    .advice li {
      margin-bottom: 8px;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .download {
      background: var(--success);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }

    .download:hover {
      background: #3ab0d9;
      transform: translateY(-2px);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }

    .tab.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .chart-container {
      height: 300px;
      margin-top: 20px;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 6px;
    }

    .tooltip i {
      color: var(--gray);
      font-size: 14px;
    }

    .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--dark);
      color: var(--light);
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <h1>Betting Strategy Calculator</h1>
      </div>
      <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
        <span>Dark Mode</span>
      </div>
    </header>

    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">Martingale Recovery Strategy</h2>
          <p class="card-subtitle">Calculate your betting strategy with a single Martingale step followed by recovery bets</p>
        </div>
        <div class="actions">
          <button id="run">
            <i class="fas fa-calculator"></i>
            Calculate
          </button>
          <a id="downloadLink" class="download">
            <i class="fas fa-download"></i>
            Export CSV
          </a>
        </div>
      </div>

      <div class="controls">
        <div class="input-group">
          <label for="base">
            <i class="fas fa-coins"></i>
            Base Stake (KES)
          </label>
          <input id="base" type="number" min="1" value="100" step="1">
        </div>
        <div class="input-group">
          <label for="legs">
            <i class="fas fa-layer-group"></i>
            Number of Legs (Max Bets)
            <div class="tooltip">
              <i class="fas fa-info-circle"></i>
              <span class="tooltip-text">Maximum number of consecutive bets in your strategy</span>
            </div>
          </label>
          <input id="legs" type="number" min="1" value="8" step="1">
        </div>
        <div class="input-group">
          <label for="pwin">
            <i class="fas fa-percentage"></i>
            Win Probability Per Bet
            <div class="tooltip">
              <i class="fas fa-info-circle"></i>
              <span class="tooltip-text">Probability of winning each individual bet (0 to 1)</span>
            </div>
          </label>
          <input id="pwin" type="number" min="0" max="1" step="0.01" value="0.5">
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="summary">Summary</div>
        <div class="tab" data-tab="table">Detailed Table</div>
        <div class="tab" data-tab="chart">Visualization</div>
      </div>

      <div class="tab-content active" id="summary-tab">
        <div class="summary-grid" id="summary">
          <!-- populated by JS -->
        </div>
        
        <div class="notice" id="evnote">
          <i class="fas fa-exclamation-circle"></i>
          <strong>Important:</strong> The calculations assume decimal odds of 2.0 (win pays 2× stake). Adjust your strategy based on your risk tolerance.
        </div>
      </div>

      <div class="tab-content" id="table-tab">
        <div class="table-container">
          <table id="table">
            <thead>
              <tr>
                <th>Bet #</th>
                <th>Stake (KES)</th>
                <th>Cumulative Before (KES)</th>
                <th>Cumulative After (KES)</th>
                <th>Probability Reach</th>
                <th>Probability Win Here</th>
                <th>Net If Win</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="chart-tab">
        <div class="chart-container" id="chart">
          <canvas id="strategyChart"></canvas>
        </div>
      </div>

      <div class="advice">
        <h3><i class="fas fa-lightbulb"></i> Strategy Advice</h3>
        <ul>
          <li><strong>Long-term Expectation</strong>: With fair odds (2.0) and constant win probability, this strategy has zero expected value over infinite bets. However, practical constraints like betting limits and finite bankroll create negative expected value when capping the number of legs.</li>
          <li><strong>Profit Mechanism</strong>: Only the first bet yields profit (+base stake). Wins on subsequent bets simply recover your cumulative investment (net 0).</li>
          <li><strong>Risk Management</strong>: This strategy carries significant tail risk. Decide on a hard stop (maximum legs) and accept the worst-case loss before starting.</li>
          <li><strong>Practical Suggestions</strong>: Consider reducing base stake, setting conservative maximum legs, or exploring alternative strategies like fractional staking if you have an edge.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const icon = themeToggle.querySelector('i');
      const text = themeToggle.querySelector('span');
      
      if (document.body.classList.contains('dark-mode')) {
        icon.className = 'fas fa-sun';
        text.textContent = 'Light Mode';
      } else {
        icon.className = 'fas fa-moon';
        text.textContent = 'Dark Mode';
      }
    });

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });

    // Chart initialization
    let strategyChart = null;

    function computeSequence(b, K, pWin) {
      const stakes = [];
      const cumulative = [];
      
      for(let k = 1; k <= K; k++) {
        if(k === 1) {
          stakes.push(b);
          cumulative.push(b);
        } else {
          const sumPrev = stakes.reduce((a, c) => a + c, 0);
          const s = sumPrev;
          stakes.push(s);
          cumulative.push(sumPrev + s);
        }
      }
      
      return {stakes, cumulative};
    }

    function format(n) {
      return Number(n).toLocaleString(undefined, {maximumFractionDigits: 2});
    }

    function renderChart(rows) {
      const ctx = document.getElementById('strategyChart').getContext('2d');
      
      if (strategyChart) {
        strategyChart.destroy();
      }
      
      const labels = rows.map(r => `Bet ${r.k}`);
      const stakes = rows.map(r => r.s);
      const cumulative = rows.map(r => r.S_k);
      
      strategyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Stake Amount',
              data: stakes,
              backgroundColor: 'rgba(67, 97, 238, 0.7)',
              borderColor: 'rgba(67, 97, 238, 1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Cumulative Investment',
              data: cumulative,
              type: 'line',
              borderColor: 'rgba(248, 150, 30, 1)',
              backgroundColor: 'rgba(248, 150, 30, 0.1)',
              borderWidth: 2,
              fill: false,
              yAxisID: 'y'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Amount (KES)'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Betting Strategy Progression'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    function render() {
      const b = Number(document.getElementById('base').value) || 100;
      const K = Math.max(1, Math.floor(Number(document.getElementById('legs').value) || 8));
      const pWin = Number(document.getElementById('pwin').value) || 0.5;
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      
      const {stakes, cumulative} = computeSequence(b, K, pWin);
      
      // Compute additional stats
      const rows = [];
      for(let k = 1; k <= K; k++) {
        const s = stakes[k-1];
        const cumBefore = stakes.slice(0, k-1).reduce((a, c) => a + c, 0) || 0;
        const S_k = stakes.slice(0, k).reduce((a, c) => a + c, 0);
        const probReach = Math.pow(1 - pWin, k-1);
        const probWinHere = probReach * pWin;
        let netIfWin;
        
        if(k === 1) {
          netIfWin = b;
        } else {
          netIfWin = 0;
        }
        
        rows.push({k, s, cumBefore, S_k, probReach, probWinHere, netIfWin});
      }

      // Populate table
      for(const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.k}</td>
          <td>${format(r.s)}</td>
          <td>${format(r.cumBefore)}</td>
          <td>${format(r.S_k)}</td>
          <td>${(r.probReach * 100).toFixed(4)}%</td>
          <td>${(r.probWinHere * 100).toFixed(4)}%</td>
          <td class="${r.netIfWin > 0 ? 'positive' : ''}">${r.netIfWin === 0 ? '0' : ('+' + format(r.netIfWin))}</td>
        `;
        tbody.appendChild(tr);
      }

      // Summary cards
      const totalCommittedIfLoseAll = rows[rows.length-1].S_k;
      const probLoseAll = Math.pow(1 - pWin, K);
      const probAtLeastOneWin = 1 - probLoseAll;
      const expectedNet = (pWin * b) - (probLoseAll * totalCommittedIfLoseAll);

      const summary = document.getElementById('summary');
      summary.innerHTML = '';
      
      const makeStat = (title, val, type = '') => {
        return `
          <div class="stat ${type}">
            <div class="stat-title">${title}</div>
            <div class="stat-value">${val}</div>
          </div>
        `;
      };
      
      summary.innerHTML = 
        makeStat('Total Worst-Case Loss', 'KES ' + format(totalCommittedIfLoseAll), 'danger') +
        makeStat('Probability Lose All Legs', (probLoseAll * 100).toFixed(6) + '%', 'danger') +
        makeStat('Probability At Least One Win', (probAtLeastOneWin * 100).toFixed(6) + '%', 'success') +
        makeStat('Expected Net Return', 'KES ' + format(expectedNet), expectedNet >= 0 ? 'success' : 'warning');

      // EV note
      const evnote = document.getElementById('evnote');
      evnote.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <strong>Strategy Analysis:</strong> With a base stake of KES ${b}, ${K} legs, and a per-bet win probability of ${pWin}, 
        your worst-case loss if all bets fail is <strong>KES ${format(totalCommittedIfLoseAll)}</strong>. 
        The chance of this happening is ${(probLoseAll * 100).toFixed(6)}%. 
        Your expected net return with this strategy is <strong>KES ${format(expectedNet)}</strong>.
      `;

      // Prepare CSV for download
      const csvRows = [['bet', 'stake', 'cum_before', 'cum_after', 'prob_reach', 'prob_win_here', 'net_if_win']];
      for(const r of rows) {
        csvRows.push([r.k, r.s, r.cumBefore, r.S_k, r.probReach, r.probWinHere, r.netIfWin]);
      }
      
      const csv = csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const link = document.getElementById('downloadLink');
      link.href = url;
      link.download = `betting_strategy_b${b}_legs${K}.csv`;

      // Render chart
      renderChart(rows);
    }

    document.getElementById('run').addEventListener('click', () => {
      render();
    });

    // Initial render
    document.addEventListener('DOMContentLoaded', function() {
      render();
    });
  </script>
</body>
</html>
